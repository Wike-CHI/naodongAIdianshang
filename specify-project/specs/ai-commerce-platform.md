# Feature Specification: AI 模特电商平台一体化能力

**Feature Branch**: `[001-ai-commerce-platform]`  
**Created**: 2025-10-30  
**Status**: Draft  
**Input**: User description: "/specify 整个项目   查看这个项目 确保前后端 管理后天 都能用mongoDB数据库存储 在登录注册事件能够正常运行 在订阅+积分制度下能够正常返回用户积分和状态 并存储到数据库 在前端刷新显示 确保订阅年度会员之后 还能购买积分 并正常累加 在积分明细记录这些事件 能够存储到数据库 且后台管理系统能够管理积分 读取用户数据库 读取到用户信息 生图用https://aihubmix.com/model/gemini-2.5-flash-image 里的接口和说明 实现 主要功能 AI模特生成 同版型试衣 配件试戴 姿态变换 鞋靴试穿 场景更换 商品换色   都是使用通用的工具组件的 两个参考图 三个可选 一个提示词窗口 默认点击生成 通过事件是 上传两个图片之后 点击生成 就可以调用内置的提示词来直接生成图片 生成的图片可以下载 可以缓存到用户数据库 保留一天"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - AI 模特生成首页流程 (Priority: P1)

电商用户登录后上传两张参考图（模特正面与版型示意），选择内置提示词或输入自定义补充词，点击生成完成 AI 模特输出并展示在工作台中，可下载或保存历史。

**Why this priority**: 这是平台核心价值，直接驱动用户转化与粘性。

**Independent Test**: 通过创建测试账号、上传示例图、触发生成并确认返回结果与存储流程即可验证。

**Acceptance Scenarios**:

1. **Given** 用户已登录且拥有可用积分，**When** 上传两张参考图片并点击“生成”，**Then** 系统向 AIHubMix 提交请求并在 120 秒内返回生成结果列表，成功写入 MongoDB。
2. **Given** 用户未自定义提示词，**When** 点击“生成”，**Then** 系统使用模板提示词并标记默认配置，生成结果可在缓存有效期内再次查看与下载。

---

### User Story 2 - 订阅与积分联动消费 (Priority: P1)

用户可购买年度会员或单次积分包，系统自动计算权益、扣减积分并在前端实时刷新剩余额度、订阅状态与到账记录。

**Why this priority**: 保障商业化闭环，提高付费转化效率。

**Independent Test**: 通过创建/取消订阅、购买积分、触发多次生成并验证扣减与刷新逻辑即可独立验收。

**Acceptance Scenarios**:

1. **Given** 用户开通年度会员，**When** 触发生成，**Then** 系统优先扣减会员赠送积分并记录流水。
2. **Given** 用户已用完会员积分但仍为年度会员，**When** 购买额外积分包并再次生成，**Then** 积分正确累加并扣减，前端和后台均能查询到最新余额与明细。

---

### User Story 3 - 积分明细与生成记录管理 (Priority: P2)

用户与后台管理员可查看按时间排序的积分明细、生成记录，支持按类型筛选与导出缓存数据。

**Why this priority**: 透明的积分流水与生成记录提升信任度，可定位问题与支持售后。

**Independent Test**: 通过触发多种事件（订阅、购买、生成、缓存过期），验证 MongoDB 中记录完整性与查询接口。

**Acceptance Scenarios**:

1. **Given** 用户完成三次不同类型的积分变动，**When** 打开积分明细页，**Then** 可看到事件时间、变动值、来源，并支持分页。
2. **Given** 管理员在后台查看生成记录，**When** 选择指定用户，**Then** 展示最近 24 小时缓存文件与过期状态。

---

### User Story 4 - 管理后台运营视角 (Priority: P2)

后台管理员可以查看用户列表、订阅状态、积分余额、生成记录，并能对异常订单或生成任务进行重试/作废处理。

**Why this priority**: 保障运营效率，支持人工干预与客服。

**Independent Test**: 使用管理员角色登录后台，执行查询、筛选、导出和任务重试操作，确认权限与审计日志。

**Acceptance Scenarios**:

1. **Given** 管理员登录后台，**When** 打开用户详情页，**Then** 能看到订阅、积分、生成记录和最近登录信息。
2. **Given** 某次生成失败，**When** 管理员点击“重试”，**Then** 系统重新调用 AIHubMix 接口并记录重试人、时间与结果。

---

### User Story 5 - 模型配置与通用组件 (Priority: P3)

运营可在后台配置各类生成预设（同版型试衣、配件试戴、姿态变换、鞋靴试穿、场景更换、商品换色），并在前端通用组件中自动更新。

**Why this priority**: 快速适配新品活动，提高转化效率。

**Independent Test**: 在后台新增/下线一个预设，前端刷新后可用新的模板进行生成。

**Acceptance Scenarios**:

1. **Given** 运营新增“冬季场景”预设，**When** 用户选择该预设生成，**Then** 请求体自动加载对应提示词与参数。
2. **Given** 运营下线“配件试戴”预设，**When** 用户进入工作台，**Then** 不再显示该选项且历史记录保留。

---

### Edge Cases

- 积分不足或订阅过期时的生成处理（阻断请求并给出充值指引）。
- AIHubMix 接口超时/错误时的重试与失败回滚策略。
- 上传图片规格不符或识别失败时的提示与安全校验。
- 缓存 24 小时后自动失效、对应文件清理与记录状态更新。
- 同一用户并发提交多任务的限流与排队策略。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在 MongoDB 中持久化用户账户、订阅、积分流水、生成任务、生成结果等数据实体。
- **FR-002**: 系统必须提供安全的注册、登录、刷新 Token 接口，并在所有敏感操作校验身份。
- **FR-003**: 系统必须集成 `https://aihubmix.com/model/gemini-2.5-flash-image` 接口，封装统一的生成服务并支持上传两张参考图及模板提示词。
- **FR-004**: 前端必须提供通用生成组件，支持模板选择、自定义提示词、结果展示、下载与保存到用户历史。
- **FR-005**: 系统必须实现积分账户模型，支持订阅赠送、购买积分、生成扣减、手动调整等事件，并保证事务一致性。
- **FR-006**: 年度会员到期前需提前 7 天推送提醒，并在到期后自动限制会员权益但保留普通积分能力。
- **FR-007**: 积分明细需按时间倒序分页展示，提供类型筛选，并暴露导出 API 供后台使用。
- **FR-008**: 生成结果必须缓存 24 小时，过期后自动标记并删除文件，同时保留元数据以供审计。
- **FR-009**: 管理后台必须提供用户查询、积分调整、生成任务重试/取消与模型预设管理能力。
- **FR-010**: 系统必须为生成请求建立审计日志，记录发起人、耗时、消耗积分、返回状态与重试次数。
- **FR-011**: 系统必须提供健康检查与速率限制，防止滥用 API 与避免 AIHubMix 限流。
- **FR-012**: 前端与后台必须实时展示积分和订阅状态变更，利用 WebSocket 或轮询确保 5 秒内刷新。
- **FR-013**: 上传图片必须通过大小、格式与内容安全校验，并存储在受限的对象存储或加密文件系统。
- **FR-014**: 系统必须在生成失败时返还扣减的积分或标记为等待人工处理，避免用户损失。
- **FR-015**: 所有后台操作需记录操作员、时间、变更前后数据，满足审计要求。

### Key Entities *(include if feature involves data)*

- **User**: 存储账户信息、密码 Hash、联系方式、角色、订阅状态、积分余额快照。
- **SubscriptionPlan**: 年度会员、月度或活动套餐定义，包含权益、价格、积分赠送额度。
- **UserSubscription**: 用户与订阅计划的关系表，记录生效时间、到期时间、状态与续费信息。
- **CreditLedgerEntry**: 积分流水记录，字段含事件类型、变动值、余额、关联任务或订单 ID。
- **GenerationTask**: 生成任务元数据，包含图片引用、提示词、模板、状态、消耗积分、响应时间。
- **GenerationAsset**: 生成产出文件记录，包含存储路径、过期时间、下载统计、归属用户。
- **ModelPreset**: 预设模板配置，含名称、用途、基准提示词、可调参数、启用状态。
- **AdminAuditLog**: 管理后台操作记录，追踪敏感变更与重试。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 95% 的生成任务在 120 秒内返回成功结果并正确存储。
- **SC-002**: 订阅与积分扣减逻辑的自动化测试覆盖关键路径（生成、退款、补偿）且全部通过。
- **SC-003**: 前端用户页面在积分或订阅变动后 5 秒内完成状态刷新，用户满意度问卷达到 4.5/5。
- **SC-004**: 管理后台可在 3 次点击内定位任意用户最近 24 小时内的生成记录与积分变动。
- **SC-005**: 缓存清理任务每日成功执行，过期资产滞留率低于 1%。
